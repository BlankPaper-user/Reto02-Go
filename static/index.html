<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parser JSON de Bajo Nivel - Reto #2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="bg-primary text-white text-center py-4 mb-4">
                    <h1 class="display-4"><i class="fas fa-code"></i> Parser JSON de Bajo Nivel</h1>
                    <p class="lead">Reto #2 - Implementaci√≥n desde cero en Go</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Input Section -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white">
                        <h4><i class="fas fa-edit"></i> Entrada JSON</h4>
                    </div>
                    <div class="card-body">
                        <!-- Textarea -->
                        <div class="mb-3">
                            <textarea 
                                id="jsonInput" 
                                class="form-control font-monospace" 
                                rows="15"
                                placeholder="Ingresa tu JSON aqu√≠...

Ejemplo:
{
  &quot;nombre&quot;: &quot;Juan&quot;,
  &quot;edad&quot;: 30,
  &quot;activo&quot;: true
}"
                            ></textarea>
                        </div>

                        <!-- Control Buttons -->
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-primary" onclick="parseJSON()">
                                <i class="fas fa-search"></i> Parsear JSON
                            </button>
                            <button class="btn btn-secondary" onclick="clearInput()">
                                <i class="fas fa-trash"></i> Limpiar
                            </button>
                            <button class="btn btn-success" onclick="formatJSON()">
                                <i class="fas fa-magic"></i> Formatear
                            </button>
                            <button class="btn btn-info" onclick="showExamplesModal()" data-bs-toggle="modal" data-bs-target="#examplesModal">
                                <i class="fas fa-book"></i> Ver Todos los Ejemplos
                            </button>
                        </div>

                        <!-- Stats -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="card text-center">
                                    <div class="card-body py-2">
                                        <h5 class="card-title text-primary" id="charCount">0</h5>
                                        <small class="text-muted">Caracteres</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card text-center">
                                    <div class="card-body py-2">
                                        <h5 class="card-title text-primary" id="lineCount">1</h5>
                                        <small class="text-muted">L√≠neas</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Examples -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Ejemplos R√°pidos</h6>
                            </div>
                            <div class="card-body">
                                <div class="row" id="examplesGrid">
                                    <!-- Los ejemplos se cargar√°n aqu√≠ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h4><i class="fas fa-chart-bar"></i> Resultado del Parseo</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Indicator -->
                        <div class="alert alert-info" role="alert" id="statusIndicator">
                            <i class="fas fa-clock"></i> Esperando entrada...
                        </div>

                        <!-- Result Container -->
                        <div class="card" id="resultContainer">
                            <div class="card-body">
                                <pre class="mb-0" id="resultContent">Ingresa un JSON v√°lido en el √°rea de texto de la izquierda y presiona "Parsear JSON" para ver el resultado.

<strong>Caracter√≠sticas del parser:</strong>
‚Ä¢ ‚úÖ Objetos JSON ‚Üí map[string]interface{}
‚Ä¢ ‚úÖ Arrays JSON ‚Üí []interface{}
‚Ä¢ ‚úÖ Strings con caracteres de escape
‚Ä¢ ‚úÖ N√∫meros (enteros y decimales)
‚Ä¢ ‚úÖ Booleanos (true/false)
‚Ä¢ ‚úÖ Valores null
‚Ä¢ ‚úÖ Estructuras anidadas
‚Ä¢ ‚úÖ Manejo detallado de errores</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ejemplos -->
    <div class="modal fade" id="examplesModal" tabindex="-1" aria-labelledby="examplesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="examplesModalLabel">
                        <i class="fas fa-book"></i> Biblioteca de Ejemplos JSON
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Ejemplos V√°lidos -->
                        <div class="col-md-8">
                            <h6 class="text-success"><i class="fas fa-check-circle"></i> Ejemplos V√°lidos</h6>
                            <div id="validExamples" class="mb-4">
                                <!-- Se llenar√°n din√°micamente -->
                            </div>
                        </div>
                        
                        <!-- Ejemplos Inv√°lidos -->
                        <div class="col-md-4">
                            <h6 class="text-danger"><i class="fas fa-times-circle"></i> Ejemplos Inv√°lidos</h6>
                            <div id="invalidExamples">
                                <!-- Se llenar√°n din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let examples = [];

        // Cargar ejemplos al inicio
        document.addEventListener('DOMContentLoaded', function() {
            loadExamples();
            updateStats();
            
            // Actualizar estad√≠sticas cuando el usuario escriba
            document.getElementById('jsonInput').addEventListener('input', updateStats);
        });

        function updateStats() {
            const input = document.getElementById('jsonInput').value;
            document.getElementById('charCount').textContent = input.length;
            document.getElementById('lineCount').textContent = (input.match(/\n/g) || []).length + 1;
        }

        async function loadExamples() {
            try {
                console.log('üîÑ Cargando ejemplos desde el servidor...');
                updateStatus('info', '<i class="fas fa-spinner fa-spin"></i> Cargando ejemplos...');
                
                const response = await fetch('/api/examples');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Ejemplos cargados desde servidor:', data);
                examples = data;
                renderExamples();
                
                updateStatus('success', '<i class="fas fa-check"></i> Ejemplos cargados correctamente');
                setTimeout(() => {
                    updateStatus('info', '<i class="fas fa-clock"></i> Esperando entrada...');
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error cargando ejemplos:', error);
                updateStatus('warning', '<i class="fas fa-exclamation-triangle"></i> Usando ejemplos por defecto');
                renderDefaultExamples();
                
                setTimeout(() => {
                    updateStatus('info', '<i class="fas fa-clock"></i> Esperando entrada...');
                }, 2000);
            }
        }

        function showExamplesModal() {
            console.log('üìö Mostrando modal de ejemplos');
            populateExamplesModal();
        }

        function populateExamplesModal() {
            const validContainer = document.getElementById('validExamples');
            const invalidContainer = document.getElementById('invalidExamples');
            
            validContainer.innerHTML = '';
            invalidContainer.innerHTML = '';

            // Mostrar ejemplos v√°lidos
            if (examples.ejemplos && examples.ejemplos.length > 0) {
                examples.ejemplos.forEach((example, index) => {
                    const card = createExampleCard(example, index, 'valid');
                    validContainer.appendChild(card);
                });
            } else {
                validContainer.innerHTML = '<p class="text-muted">No hay ejemplos v√°lidos disponibles.</p>';
            }

            // Mostrar ejemplos inv√°lidos
            if (examples.ejemplos_invalidos && examples.ejemplos_invalidos.length > 0) {
                examples.ejemplos_invalidos.forEach((example, index) => {
                    const card = createExampleCard(example, index, 'invalid');
                    invalidContainer.appendChild(card);
                });
            } else {
                invalidContainer.innerHTML = '<p class="text-muted">No hay ejemplos inv√°lidos disponibles.</p>';
            }
        }

        function createExampleCard(example, index, type) {
            const card = document.createElement('div');
            card.className = 'card mb-3';
            
            const borderClass = type === 'valid' ? 'border-success' : 'border-danger';
            card.classList.add(borderClass);
            
            const headerClass = type === 'valid' ? 'bg-success' : 'bg-danger';
            const icon = type === 'valid' ? 'fa-check' : 'fa-times';
            
            card.innerHTML = `
                <div class="card-header ${headerClass} text-white py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <small><i class="fas ${icon}"></i> ${example.nombre}</small>
                        <button class="btn btn-sm btn-light" onclick="selectExampleFromModal('${type}', ${index})" data-bs-dismiss="modal">
                            <i class="fas fa-arrow-right"></i> Usar
                        </button>
                    </div>
                </div>
                <div class="card-body py-2">
                    <pre class="mb-0" style="font-size: 0.8em; max-height: 100px; overflow-y: auto;">${example.json}</pre>
                </div>
            `;
            
            return card;
        }

        function selectExampleFromModal(type, index) {
            let selectedExample;
            
            if (type === 'valid') {
                selectedExample = examples.ejemplos[index];
            } else {
                selectedExample = examples.ejemplos_invalidos[index];
            }
            
            console.log(`üìù Seleccionando ejemplo ${type}:`, selectedExample);
            setExample(selectedExample.json);
            
            // Mostrar mensaje informativo
            if (type === 'invalid') {
                updateStatus('warning', '<i class="fas fa-exclamation-triangle"></i> ¬°Cuidado! Este es un ejemplo inv√°lido para probar errores');
            } else {
                updateStatus('success', '<i class="fas fa-check"></i> Ejemplo cargado - presiona "Parsear JSON"');
            }
        }

        function renderExamples() {
            const grid = document.getElementById('examplesGrid');
            grid.innerHTML = '';

            let examplesList = [];
            
            // Verificar diferentes estructuras de respuesta
            if (examples.ejemplos && Array.isArray(examples.ejemplos)) {
                examplesList = examples.ejemplos;
            } else if (Array.isArray(examples)) {
                examplesList = examples;
            } else {
                console.log('Estructura de ejemplos no reconocida:', examples);
                renderDefaultExamples();
                return;
            }

            console.log('Renderizando ejemplos:', examplesList);

            if (examplesList.length === 0) {
                renderDefaultExamples();
                return;
            }

            examplesList.slice(0, 6).forEach((example, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-2';
                
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-primary btn-sm w-100';
                btn.innerHTML = `<small>${example.nombre || example.name || `Ejemplo ${index + 1}`}</small>`;
                btn.onclick = () => {
                    console.log('Cargando ejemplo:', example);
                    setExample(example.json);
                };
                
                col.appendChild(btn);
                grid.appendChild(col);
            });
        }

        function renderDefaultExamples() {
            console.log('üìã Renderizando ejemplos por defecto');
            const defaultExamples = [
                { nombre: 'Objeto Simple', json: '{"name": "Juan", "age": 30}' },
                { nombre: 'Array', json: '["a", "b", "c"]' },
                { nombre: 'Anidado', json: '{"user": {"name": "Ana"}}' },
                { nombre: 'Mixto', json: '{"str": "texto", "num": 42, "bool": true}' }
            ];

            const grid = document.getElementById('examplesGrid');
            grid.innerHTML = '';

            defaultExamples.forEach(example => {
                const col = document.createElement('div');
                col.className = 'col-md-6 mb-2';
                
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary btn-sm w-100';
                btn.innerHTML = `<small><i class="fas fa-play"></i> ${example.nombre}</small>`;
                btn.onclick = () => {
                    console.log('üéØ Cargando ejemplo por defecto:', example);
                    setExample(example.json);
                };
                
                col.appendChild(btn);
                grid.appendChild(col);
            });

            // Mensaje informativo
            const infoCol = document.createElement('div');
            infoCol.className = 'col-12 mt-2';
            infoCol.innerHTML = '<small class="text-muted"><i class="fas fa-info-circle"></i> Ejemplos por defecto (servidor no disponible)</small>';
            grid.appendChild(infoCol);
        }

        function setExample(jsonString) {
            console.log('Estableciendo ejemplo:', jsonString);
            document.getElementById('jsonInput').value = jsonString;
            updateStats();
            // Auto-parsear despu√©s de un breve delay
            setTimeout(() => parseJSON(), 500);
        }

        function clearInput() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('resultContent').innerHTML = '√Årea limpiada. Ingresa un nuevo JSON para parsear.';
            document.getElementById('resultContainer').className = 'card';
            updateStatus('info', '<i class="fas fa-clock"></i> Esperando entrada...');
            updateStats();
        }

        function formatJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            if (!input) {
                updateStatus('warning', '<i class="fas fa-exclamation-triangle"></i> No hay contenido para formatear');
                return;
            }

            try {
                const parsed = JSON.parse(input);
                const formatted = JSON.stringify(parsed, null, 2);
                document.getElementById('jsonInput').value = formatted;
                updateStats();
                updateStatus('success', '<i class="fas fa-check"></i> JSON formateado correctamente');
            } catch (error) {
                updateStatus('danger', '<i class="fas fa-times"></i> No se puede formatear: JSON inv√°lido');
            }
        }

        async function parseJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            
            if (!input) {
                updateStatus('warning', '<i class="fas fa-exclamation-triangle"></i> Por favor ingresa un JSON');
                return;
            }

            // Mostrar estado de carga
            updateStatus('info', '<i class="fas fa-spinner fa-spin"></i> Parseando...');

            try {
                console.log('Enviando JSON para parsear:', input);
                
                const response = await fetch('/api/parse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ json: input })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Resultado del parseo:', result);
                
                if (result.success) {
                    displaySuccess(result.result);
                } else {
                    displayError(result.error);
                }
            } catch (error) {
                console.error('Error en parseJSON:', error);
                displayError('Error de conexi√≥n: ' + error.message);
            }
        }

        function displaySuccess(result) {
            updateStatus('success', '<i class="fas fa-check"></i> JSON parseado exitosamente');
            
            const container = document.getElementById('resultContainer');
            const content = document.getElementById('resultContent');
            
            container.className = 'card border-success';
            
            // Formatear el resultado de manera legible
            const formattedResult = formatGoValue(result, 0);
            content.innerHTML = `<div class="text-success fw-bold mb-3">‚úÖ Parseo exitoso!</div>

<strong>Resultado (estructura Go):</strong>
${formattedResult}

<strong>JSON formateado:</strong>
${JSON.stringify(result, null, 2)}`;
        }

        function displayError(error) {
            updateStatus('danger', '<i class="fas fa-times"></i> Error en el parseo');
            
            const container = document.getElementById('resultContainer');
            const content = document.getElementById('resultContent');
            
            container.className = 'card border-danger';
            content.innerHTML = `<div class="text-danger fw-bold mb-3">‚ùå Error de parseo:</div>

${error}

<strong>Consejos para corregir:</strong>
‚Ä¢ Verifica que todas las llaves {} y corchetes [] est√©n balanceados
‚Ä¢ Aseg√∫rate de que las cadenas est√©n entre comillas dobles
‚Ä¢ No uses comas adicionales al final de objetos o arrays
‚Ä¢ Verifica la sintaxis de n√∫meros y valores booleanos`;
        }

        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const alertClasses = {
                'info': 'alert-info',
                'success': 'alert-success', 
                'warning': 'alert-warning',
                'danger': 'alert-danger'
            };
            
            indicator.className = `alert ${alertClasses[type]} mb-3`;
            indicator.innerHTML = message;
        }

        function formatGoValue(value, indent = 0) {
            const spaces = '  '.repeat(indent);
            const nextSpaces = '  '.repeat(indent + 1);
            
            if (value === null) {
                return '<nil>';
            } else if (typeof value === 'boolean') {
                return value.toString();
            } else if (typeof value === 'number') {
                return value.toString();
            } else if (typeof value === 'string') {
                return `"${value}"`;
            } else if (Array.isArray(value)) {
                if (value.length === 0) {
                    return '[]interface{}{}';
                }
                let result = '[]interface{}{\n';
                value.forEach((item, index) => {
                    result += nextSpaces + formatGoValue(item, indent + 1);
                    if (index < value.length - 1) result += ',';
                    result += '\n';
                });
                result += spaces + '}';
                return result;
            } else if (typeof value === 'object') {
                const keys = Object.keys(value);
                if (keys.length === 0) {
                    return 'map[string]interface{}{}';
                }
                let result = 'map[string]interface{}{\n';
                keys.forEach((key, index) => {
                    result += nextSpaces + `"${key}": ${formatGoValue(value[key], indent + 1)}`;
                    if (index < keys.length - 1) result += ',';
                    result += '\n';
                });
                result += spaces + '}';
                return result;
            }
            return String(value);
        }

        // Atajos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                parseJSON();
            } else if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                clearInput();
            }
        });
    </script>
</body>
</html>