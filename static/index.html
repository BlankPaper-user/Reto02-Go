<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parser JSON de Bajo Nivel - Reto #2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="bg-primary text-white text-center py-4 mb-4">
                    <h1 class="display-4"><i class="fas fa-code"></i> Parser JSON de Bajo Nivel</h1>
                    <p class="lead">Reto #2 - Implementación desde cero en Go</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Input Section -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white">
                        <h4><i class="fas fa-edit"></i> Entrada JSON</h4>
                    </div>
                    <div class="card-body">
                        <!-- Textarea -->
                        <div class="mb-3">
                            <textarea 
                                id="jsonInput" 
                                class="form-control font-monospace" 
                                rows="15"
                                placeholder="Ingresa tu JSON aquí...

Ejemplo:
{
  &quot;nombre&quot;: &quot;Juan&quot;,
  &quot;edad&quot;: 30,
  &quot;activo&quot;: true
}"
                            ></textarea>
                        </div>

                        <!-- Control Buttons -->
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-primary" onclick="parseJSON()">
                                <i class="fas fa-search"></i> Parsear JSON
                            </button>
                            <button class="btn btn-secondary" onclick="clearInput()">
                                <i class="fas fa-trash"></i> Limpiar
                            </button>
                            <button class="btn btn-success" onclick="formatJSON()">
                                <i class="fas fa-magic"></i> Formatear
                            </button>
                            <button class="btn btn-info" onclick="loadExamples()">
                                <i class="fas fa-book"></i> Cargar Ejemplos
                            </button>
                        </div>

                        <!-- Stats -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="card text-center">
                                    <div class="card-body py-2">
                                        <h5 class="card-title text-primary" id="charCount">0</h5>
                                        <small class="text-muted">Caracteres</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card text-center">
                                    <div class="card-body py-2">
                                        <h5 class="card-title text-primary" id="lineCount">1</h5>
                                        <small class="text-muted">Líneas</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Examples -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Ejemplos Rápidos</h6>
                            </div>
                            <div class="card-body">
                                <div class="row" id="examplesGrid">
                                    <!-- Los ejemplos se cargarán aquí -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h4><i class="fas fa-chart-bar"></i> Resultado del Parseo</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Indicator -->
                        <div class="alert alert-info" role="alert" id="statusIndicator">
                            <i class="fas fa-clock"></i> Esperando entrada...
                        </div>

                        <!-- Result Container -->
                        <div class="card" id="resultContainer">
                            <div class="card-body">
                                <pre class="mb-0" id="resultContent">Ingresa un JSON válido en el área de texto de la izquierda y presiona "Parsear JSON" para ver el resultado.

<strong>Características del parser:</strong>
• ✅ Objetos JSON → map[string]interface{}
• ✅ Arrays JSON → []interface{}
• ✅ Strings con caracteres de escape
• ✅ Números (enteros y decimales)
• ✅ Booleanos (true/false)
• ✅ Valores null
• ✅ Estructuras anidadas
• ✅ Manejo detallado de errores</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let examples = [];

        // Cargar ejemplos al inicio
        document.addEventListener('DOMContentLoaded', function() {
            loadExamples();
            updateStats();
            
            // Actualizar estadísticas cuando el usuario escriba
            document.getElementById('jsonInput').addEventListener('input', updateStats);
        });

        function updateStats() {
            const input = document.getElementById('jsonInput').value;
            document.getElementById('charCount').textContent = input.length;
            document.getElementById('lineCount').textContent = (input.match(/\n/g) || []).length + 1;
        }

        async function loadExamples() {
            try {
                console.log('Cargando ejemplos...');
                const response = await fetch('/api/examples');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Ejemplos cargados:', data);
                examples = data;
                renderExamples();
            } catch (error) {
                console.error('Error cargando ejemplos:', error);
                renderDefaultExamples();
            }
        }

        function renderExamples() {
            const grid = document.getElementById('examplesGrid');
            grid.innerHTML = '';

            let examplesList = [];
            
            // Verificar diferentes estructuras de respuesta
            if (examples.ejemplos && Array.isArray(examples.ejemplos)) {
                examplesList = examples.ejemplos;
            } else if (Array.isArray(examples)) {
                examplesList = examples;
            } else {
                console.log('Estructura de ejemplos no reconocida:', examples);
                renderDefaultExamples();
                return;
            }

            console.log('Renderizando ejemplos:', examplesList);

            if (examplesList.length === 0) {
                renderDefaultExamples();
                return;
            }

            examplesList.slice(0, 6).forEach((example, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-2';
                
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-primary btn-sm w-100';
                btn.innerHTML = `<small>${example.nombre || example.name || `Ejemplo ${index + 1}`}</small>`;
                btn.onclick = () => {
                    console.log('Cargando ejemplo:', example);
                    setExample(example.json);
                };
                
                col.appendChild(btn);
                grid.appendChild(col);
            });
        }

        function renderDefaultExamples() {
            console.log('Renderizando ejemplos por defecto');
            const defaultExamples = [
                { nombre: 'Objeto Simple', json: '{"name": "Juan", "age": 30}' },
                { nombre: 'Array', json: '["a", "b", "c"]' },
                { nombre: 'Anidado', json: '{"user": {"name": "Ana"}}' },
                { nombre: 'Mixto', json: '{"str": "texto", "num": 42, "bool": true}' },
                { nombre: 'Con null', json: '{"valor": null, "activo": false}' },
                { nombre: 'Array Objetos', json: '[{"id": 1}, {"id": 2}]' }
            ];

            const grid = document.getElementById('examplesGrid');
            grid.innerHTML = '';

            defaultExamples.forEach(example => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-2';
                
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-primary btn-sm w-100';
                btn.innerHTML = `<small>${example.nombre}</small>`;
                btn.onclick = () => {
                    console.log('Cargando ejemplo por defecto:', example);
                    setExample(example.json);
                };
                
                col.appendChild(btn);
                grid.appendChild(col);
            });
        }

        function setExample(jsonString) {
            console.log('Estableciendo ejemplo:', jsonString);
            document.getElementById('jsonInput').value = jsonString;
            updateStats();
            // Auto-parsear después de un breve delay
            setTimeout(() => parseJSON(), 500);
        }

        function clearInput() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('resultContent').innerHTML = 'Área limpiada. Ingresa un nuevo JSON para parsear.';
            document.getElementById('resultContainer').className = 'card';
            updateStatus('info', '<i class="fas fa-clock"></i> Esperando entrada...');
            updateStats();
        }

        function formatJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            if (!input) {
                updateStatus('warning', '<i class="fas fa-exclamation-triangle"></i> No hay contenido para formatear');
                return;
            }

            try {
                const parsed = JSON.parse(input);
                const formatted = JSON.stringify(parsed, null, 2);
                document.getElementById('jsonInput').value = formatted;
                updateStats();
                updateStatus('success', '<i class="fas fa-check"></i> JSON formateado correctamente');
            } catch (error) {
                updateStatus('danger', '<i class="fas fa-times"></i> No se puede formatear: JSON inválido');
            }
        }

        async function parseJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            
            if (!input) {
                updateStatus('warning', '<i class="fas fa-exclamation-triangle"></i> Por favor ingresa un JSON');
                return;
            }

            // Mostrar estado de carga
            updateStatus('info', '<i class="fas fa-spinner fa-spin"></i> Parseando...');

            try {
                console.log('Enviando JSON para parsear:', input);
                
                const response = await fetch('/api/parse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ json: input })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Resultado del parseo:', result);
                
                if (result.success) {
                    displaySuccess(result.result);
                } else {
                    displayError(result.error);
                }
            } catch (error) {
                console.error('Error en parseJSON:', error);
                displayError('Error de conexión: ' + error.message);
            }
        }

        function displaySuccess(result) {
            updateStatus('success', '<i class="fas fa-check"></i> JSON parseado exitosamente');
            
            const container = document.getElementById('resultContainer');
            const content = document.getElementById('resultContent');
            
            container.className = 'card border-success';
            
            // Formatear el resultado de manera legible
            const formattedResult = formatGoValue(result, 0);
            content.innerHTML = `<div class="text-success fw-bold mb-3">✅ Parseo exitoso!</div>

<strong>Resultado (estructura Go):</strong>
${formattedResult}

<strong>JSON formateado:</strong>
${JSON.stringify(result, null, 2)}`;
        }

        function displayError(error) {
            updateStatus('danger', '<i class="fas fa-times"></i> Error en el parseo');
            
            const container = document.getElementById('resultContainer');
            const content = document.getElementById('resultContent');
            
            container.className = 'card border-danger';
            content.innerHTML = `<div class="text-danger fw-bold mb-3">❌ Error de parseo:</div>

${error}

<strong>Consejos para corregir:</strong>
• Verifica que todas las llaves {} y corchetes [] estén balanceados
• Asegúrate de que las cadenas estén entre comillas dobles
• No uses comas adicionales al final de objetos o arrays
• Verifica la sintaxis de números y valores booleanos`;
        }

        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const alertClasses = {
                'info': 'alert-info',
                'success': 'alert-success', 
                'warning': 'alert-warning',
                'danger': 'alert-danger'
            };
            
            indicator.className = `alert ${alertClasses[type]} mb-3`;
            indicator.innerHTML = message;
        }

        function formatGoValue(value, indent = 0) {
            const spaces = '  '.repeat(indent);
            const nextSpaces = '  '.repeat(indent + 1);
            
            if (value === null) {
                return '<nil>';
            } else if (typeof value === 'boolean') {
                return value.toString();
            } else if (typeof value === 'number') {
                return value.toString();
            } else if (typeof value === 'string') {
                return `"${value}"`;
            } else if (Array.isArray(value)) {
                if (value.length === 0) {
                    return '[]interface{}{}';
                }
                let result = '[]interface{}{\n';
                value.forEach((item, index) => {
                    result += nextSpaces + formatGoValue(item, indent + 1);
                    if (index < value.length - 1) result += ',';
                    result += '\n';
                });
                result += spaces + '}';
                return result;
            } else if (typeof value === 'object') {
                const keys = Object.keys(value);
                if (keys.length === 0) {
                    return 'map[string]interface{}{}';
                }
                let result = 'map[string]interface{}{\n';
                keys.forEach((key, index) => {
                    result += nextSpaces + `"${key}": ${formatGoValue(value[key], indent + 1)}`;
                    if (index < keys.length - 1) result += ',';
                    result += '\n';
                });
                result += spaces + '}';
                return result;
            }
            return String(value);
        }

        // Atajos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                parseJSON();
            } else if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                clearInput();
            }
        });
    </script>
</body>
</html>